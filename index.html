<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circe Productivity Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['Georgia', 'Cambria', '"Times New Roman"', 'Times', 'serif'],
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'bounce-short': 'bounce 1s infinite 2',
                    }
                }
            }
        }
    </script>

    <!-- React & Dependencies via Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react?deps=react@18.2.0"
      }
    }
    </script>

    <!-- Babel for JSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Smooth transitions for theme switching */
        body { transition: background-color 0.3s ease, color 0.3s ease; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Play, 
            Pause, 
            RotateCcw, 
            Settings, 
            BookOpen, 
            HeartPulse, 
            Coffee, 
            Dumbbell,
            X,
            StickyNote,
            PenLine,
            Sun,
            Moon,
            Flame
        } from 'lucide-react';

        // --- Components ---

        const ProgressBar = ({ current, target, colorClass }) => {
            const percentage = target > 0 ? Math.min(100, (current / target) * 100) : 0;
            
            return (
                <div className="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5 mt-2">
                <div 
                    className={`h-2.5 rounded-full transition-all duration-500 ${colorClass}`} 
                    style={{ width: `${percentage}%` }}
                ></div>
                </div>
            );
        };

        const formatTime = (seconds) => {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            
            if (h > 0) {
                return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        };

        // Default Configuration
        const DEFAULT_TRACKERS = [
            { id: 'lifepulse', name: 'LifePulse', target: 3 * 3600, current: 3 * 3600, icon: HeartPulse, color: 'bg-rose-500' },
            { id: 'reading', name: 'Reading', target: 3 * 3600, current: 3 * 3600, icon: BookOpen, color: 'bg-indigo-500' },
            { id: 'workout', name: 'Working Out', target: 1 * 3600, current: 1 * 3600, icon: Dumbbell, color: 'bg-emerald-500' },
            { id: 'resting', name: 'Resting', target: 0, current: 0, icon: Coffee, color: 'bg-amber-500' },
        ];

        function CirceApp() {
            // --- Initialization Logic (LocalStorage) ---
            
            const getInitialTrackers = () => {
                const savedDate = localStorage.getItem('circe-date');
                const todayStr = new Date().toDateString();
                
                // If saved date is NOT today, return defaults (Daily Reset)
                if (savedDate !== todayStr) {
                    return DEFAULT_TRACKERS;
                }
                
                // Otherwise load progress
                const savedTrackers = localStorage.getItem('circe-trackers');
                return savedTrackers ? JSON.parse(savedTrackers) : DEFAULT_TRACKERS;
            };

            const getInitialState = (key, defaultValue) => {
                const saved = localStorage.getItem(key);
                return saved ? JSON.parse(saved) : defaultValue;
            };

            // --- State ---
            const [currentDate, setCurrentDate] = useState(new Date());
            const [isDarkMode, setIsDarkMode] = useState(() => getInitialState('circe-darkmode', true));
            
            // Gamification State
            const [streak, setStreak] = useState(() => getInitialState('circe-streak', 0));
            const [lastStreakDate, setLastStreakDate] = useState(() => localStorage.getItem('circe-lastStreakDate') || '');
            const [goalsMetToday, setGoalsMetToday] = useState(false);

            // Pomodoro State
            const [pomoMode, setPomoMode] = useState('work');
            const [pomoTime, setPomoTime] = useState(25 * 60);
            const [isPomoRunning, setIsPomoRunning] = useState(false);
            const [pomoSettings, setPomoSettings] = useState(() => getInitialState('circe-pomoSettings', { work: 25, shortBreak: 5, longBreak: 15 }));
            const [showPomoSettings, setShowPomoSettings] = useState(false);

            // Category Trackers State
            const [trackers, setTrackers] = useState(getInitialTrackers);
            const [activeTrackerId, setActiveTrackerId] = useState(null);

            // Notepad State
            const [noteContent, setNoteContent] = useState(() => localStorage.getItem('circe-notes') || '');

            // --- Persistence Effects ---

            // Save basic settings & notes immediately on change
            useEffect(() => { localStorage.setItem('circe-darkmode', JSON.stringify(isDarkMode)); }, [isDarkMode]);
            useEffect(() => { localStorage.setItem('circe-pomoSettings', JSON.stringify(pomoSettings)); }, [pomoSettings]);
            useEffect(() => { localStorage.setItem('circe-notes', noteContent); }, [noteContent]);
            useEffect(() => { localStorage.setItem('circe-streak', JSON.stringify(streak)); }, [streak]);
            useEffect(() => { localStorage.setItem('circe-lastStreakDate', lastStreakDate); }, [lastStreakDate]);

            // Save Trackers & Date
            useEffect(() => {
                localStorage.setItem('circe-trackers', JSON.stringify(trackers));
                localStorage.setItem('circe-date', new Date().toDateString());
            }, [trackers]);


            // --- Logic Effects ---

            // Clock Update
            useEffect(() => {
                const timer = setInterval(() => setCurrentDate(new Date()), 60000); 
                return () => clearInterval(timer);
            }, []);

            // Dark Mode Class
            useEffect(() => {
                const html = document.documentElement;
                if (isDarkMode) html.classList.add('dark');
                else html.classList.remove('dark');
            }, [isDarkMode]);

            // Gamification Check
            useEffect(() => {
                const todayStr = new Date().toDateString();
                
                // Check if all count-down trackers (target > 0) are finished (current === 0)
                const mainGoals = trackers.filter(t => t.target > 0);
                const allFinished = mainGoals.every(t => t.current === 0);
                
                setGoalsMetToday(allFinished);

                if (allFinished && lastStreakDate !== todayStr) {
                    setStreak(s => s + 1);
                    setLastStreakDate(todayStr);
                    
                    // Optional: You could trigger a confetti effect here in a future update
                }
            }, [trackers, lastStreakDate]);

            // Pomodoro Timer Logic
            useEffect(() => {
                let interval = null;
                if (isPomoRunning && pomoTime > 0) {
                    interval = setInterval(() => {
                        setPomoTime((prevTime) => prevTime - 1);
                    }, 1000);
                } else if (pomoTime === 0) {
                    setIsPomoRunning(false);
                }
                return () => clearInterval(interval);
            }, [isPomoRunning, pomoTime]);

            // Category Tracker Logic
            useEffect(() => {
                let interval = null;
                if (activeTrackerId) {
                    interval = setInterval(() => {
                        setTrackers(prevTrackers => 
                            prevTrackers.map(t => {
                                if (t.id === activeTrackerId) {
                                    if (t.target > 0) {
                                        // Countdown Logic
                                        return { ...t, current: Math.max(0, t.current - 1) };
                                    } else {
                                        // Countup Logic
                                        return { ...t, current: t.current + 1 };
                                    }
                                }
                                return t;
                            })
                        );
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [activeTrackerId]);

            // --- Handlers ---

            const togglePomoTimer = () => setIsPomoRunning(!isPomoRunning);
            
            const resetPomoTimer = () => {
                setIsPomoRunning(false);
                setPomoTime(pomoSettings[pomoMode] * 60);
            };

            const changePomoMode = (mode) => {
                setPomoMode(mode);
                setIsPomoRunning(false);
                setPomoTime(pomoSettings[mode] * 60);
            };

            const updatePomoSettings = (e) => {
                const { name, value } = e.target;
                setPomoSettings(prev => ({ ...prev, [name]: parseInt(value) || 0 }));
            };

            const toggleTracker = (id) => {
                if (activeTrackerId === id) {
                    setActiveTrackerId(null);
                } else {
                    setActiveTrackerId(id);
                }
            };

            const resetTracker = (id) => {
                setTrackers(prevTrackers => 
                    prevTrackers.map(t => {
                        if (t.id === id) {
                            return { ...t, current: t.target > 0 ? t.target : 0 };
                        }
                        return t;
                    })
                );
                if (activeTrackerId === id) setActiveTrackerId(null);
            };

            // --- Render Helpers ---
            
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = currentDate.toLocaleDateString('en-US', dateOptions);

            return (
                <div className="min-h-screen bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 font-sans transition-colors duration-300">
                    
                    {/* Header */}
                    <header className="px-6 py-6 flex justify-between items-center bg-white dark:bg-slate-800 shadow-sm sticky top-0 z-50 border-b border-slate-100 dark:border-slate-800">
                        <div>
                            <h1 className="text-3xl font-serif font-bold tracking-tight text-indigo-600 dark:text-indigo-400">Circe</h1>
                            <p className="text-sm text-slate-500 dark:text-slate-400 mt-1 uppercase tracking-wider">{formattedDate}</p>
                        </div>
                        <div className="flex items-center gap-4">
                            
                            {/* Streak Counter */}
                            <div 
                                className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full border ${
                                    goalsMetToday 
                                    ? 'bg-orange-50 dark:bg-orange-900/20 border-orange-200 dark:border-orange-800 text-orange-600 dark:text-orange-400' 
                                    : 'bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-400'
                                }`}
                                title="Daily Goals Streak"
                            >
                                <Flame className={`w-4 h-4 ${goalsMetToday ? 'fill-orange-500 animate-pulse' : ''}`} />
                                <span className="font-mono font-bold text-sm">{streak}</span>
                            </div>

                            <button 
                                onClick={() => setIsDarkMode(!isDarkMode)}
                                className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 transition-colors"
                            >
                                {isDarkMode ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}
                            </button>
                            <div className="hidden md:flex w-10 h-10 rounded-full bg-indigo-100 dark:bg-indigo-900 items-center justify-center text-indigo-700 dark:text-indigo-300 font-bold">
                                C
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
                    
                        {/* Left Column: Pomo & Notepad */}
                        <div className="lg:col-span-4 space-y-6">
                            
                            {/* Pomodoro Timer */}
                            <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-8 text-center relative overflow-hidden border border-slate-100 dark:border-slate-700">
                                <div className="absolute top-4 right-4">
                                    <button onClick={() => setShowPomoSettings(!showPomoSettings)} className="text-slate-400 hover:text-indigo-500 transition">
                                        <Settings className="w-5 h-5" />
                                    </button>
                                </div>

                                {showPomoSettings ? (
                                    <div className="animate-in fade-in zoom-in duration-200">
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="font-semibold text-lg">Timer Settings</h3>
                                            <button onClick={() => { setShowPomoSettings(false); resetPomoTimer(); }}><X className="w-5 h-5" /></button>
                                        </div>
                                        <div className="space-y-4 text-left">
                                            <div>
                                                <label className="text-xs uppercase font-bold text-slate-400">Work (min)</label>
                                                <input type="number" name="work" value={pomoSettings.work} onChange={updatePomoSettings} className="w-full mt-1 p-2 bg-slate-100 dark:bg-slate-700 rounded-lg" />
                                            </div>
                                            <div>
                                                <label className="text-xs uppercase font-bold text-slate-400">Short Break (min)</label>
                                                <input type="number" name="shortBreak" value={pomoSettings.shortBreak} onChange={updatePomoSettings} className="w-full mt-1 p-2 bg-slate-100 dark:bg-slate-700 rounded-lg" />
                                            </div>
                                            <div>
                                                <label className="text-xs uppercase font-bold text-slate-400">Long Break (min)</label>
                                                <input type="number" name="longBreak" value={pomoSettings.longBreak} onChange={updatePomoSettings} className="w-full mt-1 p-2 bg-slate-100 dark:bg-slate-700 rounded-lg" />
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <>
                                        <div className="flex justify-center gap-2 mb-8">
                                            {['work', 'shortBreak', 'longBreak'].map((mode) => (
                                                <button
                                                    key={mode}
                                                    onClick={() => changePomoMode(mode)}
                                                    className={`px-3 py-1 rounded-full text-xs font-medium transition-colors ${
                                                    pomoMode === mode 
                                                        ? 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300' 
                                                        : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-300'
                                                    }`}
                                                >
                                                    {mode === 'work' ? 'Focus' : mode === 'shortBreak' ? 'Short Break' : 'Long Break'}
                                                </button>
                                            ))}
                                        </div>

                                        <div className="text-7xl font-mono font-bold tracking-tighter text-slate-800 dark:text-slate-100 mb-8">
                                            {formatTime(pomoTime)}
                                        </div>

                                        <div className="flex justify-center gap-4">
                                            <button 
                                                onClick={togglePomoTimer}
                                                className="w-14 h-14 rounded-full bg-indigo-600 hover:bg-indigo-700 text-white flex items-center justify-center shadow-lg shadow-indigo-200 dark:shadow-none transition-transform hover:scale-105 active:scale-95"
                                            >
                                                {isPomoRunning ? <Pause className="w-6 h-6 fill-current" /> : <Play className="w-6 h-6 fill-current ml-1" />}
                                            </button>
                                            <button 
                                                onClick={resetPomoTimer}
                                                className="w-14 h-14 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-600 transition"
                                            >
                                                <RotateCcw className="w-5 h-5" />
                                            </button>
                                        </div>
                                    </>
                                )}
                            </div>

                            {/* Notepad Widget */}
                            <div className="bg-yellow-50 dark:bg-yellow-900/10 rounded-2xl shadow-sm border border-yellow-100 dark:border-yellow-900/30 overflow-hidden flex flex-col h-[400px] relative">
                                <div className="p-4 border-b border-yellow-100 dark:border-yellow-900/30 flex justify-between items-center bg-yellow-50 dark:bg-yellow-900/20 z-10">
                                    <h2 className="text-xl font-semibold flex items-center gap-2 text-yellow-800 dark:text-yellow-500">
                                        <StickyNote className="w-5 h-5" />
                                        <span>Notes</span>
                                    </h2>
                                    <PenLine className="w-4 h-4 text-yellow-600 dark:text-yellow-500 opacity-50" />
                                </div>
                                
                                <div className="flex-1 relative p-0">
                                    <textarea
                                        value={noteContent}
                                        onChange={(e) => setNoteContent(e.target.value)}
                                        placeholder="Type your thoughts here..."
                                        className="w-full h-full p-6 bg-transparent resize-none focus:outline-none text-slate-700 dark:text-slate-200 text-sm leading-relaxed"
                                        style={{
                                            backgroundImage: 'linear-gradient(transparent 31px, rgba(0,0,0,0.05) 32px)',
                                            backgroundSize: '100% 32px',
                                            lineHeight: '32px'
                                        }}
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Right Column: Split Set Trackers */}
                        <div className="lg:col-span-8">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 h-full">
                                {trackers.map((tracker) => (
                                    <div 
                                        key={tracker.id}
                                        className={`
                                            relative rounded-2xl p-6 border transition-all duration-300 flex flex-col justify-between
                                            ${activeTrackerId === tracker.id 
                                            ? 'bg-white dark:bg-slate-800 border-indigo-500 shadow-md ring-1 ring-indigo-500' 
                                            : 'bg-white dark:bg-slate-800 border-slate-100 dark:border-slate-700 shadow-sm hover:shadow-md'
                                            }
                                        `}
                                    >
                                        <div className="flex justify-between items-start mb-4">
                                            <div className={`p-3 rounded-xl ${tracker.color} bg-opacity-10 text-${tracker.color.split('-')[1]}-600 dark:text-${tracker.color.split('-')[1]}-400`}>
                                                <tracker.icon className={`w-6 h-6 text-${tracker.color.split('-')[1]}-600`} />
                                            </div>
                                            <div className="text-right">
                                                <span className="block text-2xl font-mono font-semibold">
                                                    {Math.floor(tracker.current / 3600)}h {Math.floor((tracker.current % 3600) / 60)}m
                                                </span>
                                                {tracker.target > 0 ? (
                                                    <span className="text-xs text-slate-400">
                                                        Remaining
                                                    </span>
                                                ) : (
                                                    <span className="text-xs text-slate-400">
                                                        Elapsed
                                                    </span>
                                                )}
                                            </div>
                                        </div>

                                        <div>
                                            <h3 className="text-lg font-bold text-slate-800 dark:text-slate-100 mb-1">{tracker.name}</h3>
                                            <div className="flex items-center justify-between text-xs text-slate-400 mb-3">
                                                {tracker.target > 0 ? (
                                                    <span>{Math.round((tracker.current / tracker.target) * 100)}% Left</span>
                                                ) : (
                                                    <span>Open-ended session</span>
                                                )}
                                                
                                                {/* Reset Button (only if changed) */}
                                                {tracker.current !== (tracker.target > 0 ? tracker.target : 0) && (
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); resetTracker(tracker.id); }}
                                                        className="hover:text-rose-500 transition-colors p-1"
                                                        title="Reset Timer"
                                                    >
                                                        <RotateCcw className="w-3.5 h-3.5" />
                                                    </button>
                                                )}
                                            </div>
                                            
                                            {tracker.target > 0 && (
                                                <ProgressBar current={tracker.current} target={tracker.target} colorClass={tracker.color} />
                                            )}
                                        </div>

                                        <div className="mt-6">
                                            <button
                                                onClick={() => toggleTracker(tracker.id)}
                                                className={`
                                                    w-full py-3 rounded-xl font-medium flex items-center justify-center gap-2 transition-colors
                                                    ${activeTrackerId === tracker.id
                                                    ? 'bg-rose-50 dark:bg-rose-900/20 text-rose-600 dark:text-rose-400 hover:bg-rose-100 dark:hover:bg-rose-900/30'
                                                    : 'bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                                                    }
                                                `}
                                            >
                                                {activeTrackerId === tracker.id ? (
                                                    <>
                                                        <Pause className="w-4 h-4" /> Pause
                                                    </>
                                                ) : (
                                                    <>
                                                        <Play className="w-4 h-4" /> Start
                                                    </>
                                                )}
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<CirceApp />);
    </script>
</body>
</html>